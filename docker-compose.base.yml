# Docker Compose Base Configuration
# This file contains common configuration for all environments
# Usage: docker-compose -f docker-compose.base.yml -f docker-compose.{env}..yml up

version: '3.8'

services:
  # PPTX Conversion Service
  app:
    build:
      context: .
      dockerfile: Dockerfile
      target: ${DOCKER_TARGET:-production}
    image: pptist-backend:${IMAGE_TAG:-latest}
    container_name: pptist-backend-${NODE_ENV:-production}
    restart: ${RESTART_POLICY:-unless-stopped}
    environment:
      # Application
      - NODE_ENV=${NODE_ENV:-production}
      - PORT=${PORT:-3000}

      # Queue Configuration
      - QUEUE_TYPE=${QUEUE_TYPE:-memory}
      - QUEUE_CONCURRENCY=${QUEUE_CONCURRENCY:-3}
      - QUEUE_MAX_SIZE=${QUEUE_MAX_SIZE:-1000}
      - QUEUE_TIMEOUT=${QUEUE_TIMEOUT:-300000}

      # Logging
      - LOG_LEVEL=${LOG_LEVEL:-info}
      - LOG_FORMAT=${LOG_FORMAT:-json}

      # Metrics
      - METRICS_ENABLED=${METRICS_ENABLED:-true}
      - METRICS_PORT=${METRICS_PORT:-9090}

      # File Handling
      - MAX_FILE_SIZE=${MAX_FILE_SIZE:-104857600}
      - ALLOWED_ORIGINS=${ALLOWED_ORIGINS:-*}

      # CORS
      - CORS_CREDENTIALS=${CORS_CREDENTIALS:-true}

      # Rate Limiting
      - RATE_LIMIT_MAX=${RATE_LIMIT_MAX:-100}
      - RATE_LIMIT_WINDOW=${RATE_LIMIT_WINDOW:-60000}
    networks:
      - pptist-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Redis (optional, for production queue)
  redis:
    image: redis:${REDIS_VERSION:-7-alpine}
    container_name: pptist-redis-${NODE_ENV:-production}
    restart: ${RESTART_POLICY:-unless-stopped}
    command: >
      redis-server
      --appendonly ${REDIS_APPENDONLY:-yes}
      --appendfsync ${REDIS_APPENDFSYNC:-everysec}
      --maxmemory ${REDIS_MAXMEMORY:-256mb}
      --maxmemory-policy ${REDIS_MAXMEMORY_POLICY:-allkeys-lru}
    networks:
      - pptist-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

volumes:
  storage-data:
    name: pptist-storage-${NODE_ENV:-production}
  temp-data:
    name: pptist-temp-${NODE_ENV:-production}
  redis-data:
    name: pptist-redis-${NODE_ENV:-production}

networks:
  pptist-network:
    name: pptist-network-${NODE_ENV:-production}
    driver: bridge
