# PPTist Backend - 架构文档

**版本**: v1.0.0
**更新日期**: 2025-01-29

---

## 目录

- [系统架构](#系统架构)
- [模块设计](#模块设计)
- [数据流](#数据流)
- [转换流程](#转换流程)
- [队列系统](#队列系统)
- [错误处理](#错误处理)
- [性能优化](#性能优化)
- [安全性](#安全性)

---

## 系统架构

### 整体架构图

```
┌─────────────────────────────────────────────────────────────┐
│                         Client Layer                       │
│  ┌────────┐  ┌────────┐  ┌────────┐  ┌──────────┐  ┌─────┐   │
│  │ Swagger│  │Web App│  │Mobile │  │CLI Tool │  │Other│   │
│  └────┬───┘  └───┬────┘  └───┬────┘  └────┬─────┘  └──┬──┘   │
│       │         │         │        │         │        │     │
│  ┌───▼─────────▼─────────▼────────▼─────────▼────────▼─────▼─┐ │
│  │                  Fastify Web Server                      │ │
│  │  ┌──────────────────────────────────────────────────────┐  │ │
│  │  │  Middleware Layer                                     │  │ │
│  │  │  - CORS              - Rate Limit                   │  │ │
│  │  │  - Helmet            - Request ID                  │  │ │
│  │  │  - Multipart          - Validation               │  │ │
│  │  └──────────────────────────────────────────────────────┘  │ │
│  │  ┌──────────────────────────────────────────────────────┐  │ │
│  │  │              API Controllers                         │  │ │
│  │  │  ┌──────────────┐  ┌──────────────┐                 │  │ │
│  │  │  │ Convert API  │  │ Tasks API    │                 │  │ │
│  │  │  └──────┬───────┘  └──────┬───────┘                 │  │ │
│  │  │         │                    │                         │  │ │
│  │  └─────────┼────────────────────┼─────────────────────────┘  │ │
│  │            │                    │                         │  │
│  │  ┌────────▼────────────────────▼─────────────────────────┐ │ │
│  │  │              Conversion Service                      │ │ │
│  │  │  ┌──────────────────────────────────────────────┐  │ │ │
│  │  │  │  Queue Layer                                      │  │ │ │
│  │  │  │  ┌────────┐  ┌──────────┐  ┌─────────────┐  │  │ │ │
│  │  │  │  │Queue  │  │Consumer │  │  Task Store  │  │  │ │ │
│  │  │  │  └───┬────┘  └────┬─────┘  └──────┬──────┘  │  │ │ │
│  │  │  │      │             │                   │        │  │ │ │
│  │  │  │      ▼             ▼                   ▼        │  │ │ │
│  │  │  │  ┌────────────────────────────────────────────┐ │  │ │ │
│  │  │  │  │        Conversion Pipeline                  │ │  │ │ │
│  │  │  │  │  ┌────────┐  ┌──────────┐  ┌──────┐    │  │ │ │ │
│  │  │  │  │  │ Parser │  │ Converter│  │Cache │    │  │ │ │ │
│  │  │  │  │  └───┬────┘  └────┬─────┘  └──┬───┘    │  │ │ │ │
│  │  │  │  │      │             │         │       │    │  │ │ │ │
│  │  │  │  │      ▼             ▼         │       ▼    │  │ │ │ │
│  │  │  │  │  ┌──────────────────────────────────────┐ │  │ │ │ │
│  │  │  │  │  │    PPTX Processing Layer             │ │  │ │ │ │
│  │  │  │  │  │  ┌────────┐  ┌──────┐  ┌──────┐   │  │  │ │ │ │
│  │  │  │  │  │  │ Unzip │  │Parser│  │Media│   │  │  │ │ │ │
│  │  │  │  │  │  └───┬───┘  └───┬───┘  └──┬───┘   │  │  │ │ │ │
│  │  │  │  │  │      │         │        │      │    │  │ │ │ │ │
│  │  │  │  │  │      └─────────┴────────┼──────┘    │  │ │ │ │ │
│  │  │  │  │  │              Storage Layer               │    │  │ │ │ │
│  │  │  │  │  │  ┌────────┐  ┌──────────┐  ┌──────┐   │  │ │ │ │ │
│  │  │  │  │  │  │Temp   │  │File     │  │Media │   │  │  │ │ │ │
│  │  │  │  │  │  └────────┘  └──────────┘  └──────┘   │  │ │ │ │ │
│  │  │  │  │  └──────────────────────────────────────────────┘  │  │ │ │ │
│  │  │  │  │                                                     │  │ │ │ │
│  │  │  │  └─────────────────────────────────────────────────────┘  │  │ │ │
│  │  │  │                                                         │  │ │ │
│  │  │  └───────────────────────────────────────────────────────────┘  │ │ │
│  │  │                                                           │  │ │
│  │  └───────────────────────────────────────────────────────────────┘  │
│  │                                                               │
│  └───────────────────────────────────────────────────────────────┘
│
│  Supporting Services:
│  ┌─────────┐  ┌──────────┐  ┌─────────────┐  ┌──────────────┐
│  │ Redis   │  │Prometheus│  │  Grafana    │  │Alertmanager│
│  │ (Queue) │  │(Metrics) │  │(Dashboard)  │  │(Alerts)    │
│  └─────────┘  └──────────┘  └─────────────┘  └──────────────┘
└───────────────────────────────────────────────────────────────────────┘
```

---

## 模块设计

### 1. API 层 (`src/api/`)

**职责**: 处理 HTTP 请求和响应

**主要组件**:
- `controllers/` - 控制器，处理业务逻辑
- `index.ts` - 路由注册和中间件配置

**关键设计**:
- 路由按功能分组（convert, tasks）
- 统一的错误处理中间件
- 请求验证和数据清洗

### 2. 服务层 (`src/services/`)

#### 2.1 转换服务 (`conversion/`)

**职责**: PPTX 到 PPTist 的核心转换逻辑

**主要组件**:
```
conversion/
├── index.ts              # 服务入口
├── orchestrator.ts       # 转换编排
├── registry.ts          # 转换器注册表
├── converters/          # 元素转换器
│   ├── background.ts    # 背景转换
│   ├── chart.ts         # 图表转换
│   ├── image.ts         # 图片转换
│   ├── line.ts          # 线条转换
│   ├── shape.ts         # 形状转换
│   └── table.ts         # 表格转换
├── extractors/          # 数据提取
│   └── animation.ts    # 动画提取
└── handlers/           # 特殊处理
    ├── downgrade.ts     # 版本降级
    ├── external-media.ts # 外部媒体
    └── memory-degradation.ts # 内存优化
```

**设计模式**:
- **策略模式**: 不同元素类型使用不同转换器
- **注册表模式**: 动态注册和查找转换器
- **责任链模式**: 处理器链处理特殊情况

#### 2.2 PPTX 处理服务 (`pptx/`)

**职责**: 解析和提取 PPTX 文件内容

**主要组件**:
```
pptx/
├── unzip.ts              # ZIP 解压（流式）
├── parser.ts            # XML 解析
├── extract-media.ts     # 媒体提取
├── validator.ts         # 文件验证
└── structure/          # 结构定义
```

**关键特性**:
- **流式解压**: 避免内存峰值（yauzl）
- **选择性提取**: 按需提取内容
- **错误恢复**: 跳过损坏的条目

#### 2.3 队列服务 (`queue/`)

**职责**: 任务队列管理

**实现**:
- `memory.ts` - 内存队列（默认）
- `factory.ts` - 队列工厂

**接口定义**:
```typescript
interface TaskQueue {
  add(task: Task): Promise<string>;
  get(id: string): Promise<Task | null>;
  update(id: string, updates: Partial<Task>): Promise<boolean>;
  remove(id: string): Promise<boolean>;
  getStats(): Promise<QueueStats>;
}
```

#### 2.4 存储服务 (`storage/`)

**职责**: 文件和数据存储

**类型**:
- `FileStore` - 永久化文件存储
- `TempStore` - 临时文件存储（带 TTL）
- `ZipCreator` - ZIP 打包

---

## 数据流

### 转换流程数据流

```
用户上传
   ↓
[验证层]
   ├─ 文件类型检查
   ├─ 文件大小验证
   ├─ Magic Number 验证
   └─ 文件名清理
   ↓
[解析层]
   ├─ 解压 PPTX (yauzl)
   ├─ 提取 XML (fast-xml-parser)
   ├─ 提取媒体 (binary)
   └─ 解析关系
   ↓
[转换层]
   ├─ 创建转换上下文
   ├─ 转换元素 (使用注册的转换器)
   ├─ 处理特殊情况
   └─ 优化结果
   ↓
[序列化层]
   ├─ 生成 JSON
   ├─ 收集元数据
   ├─ 生成警告
   └─ 序列化输出
   ↓
[存储层]
   ├─ 保存 JSON 结果
   ├─ 保存媒体文件
   └─ 清理临时文件
   ↓
返回结果给用户
```

---

## 转换流程

### 1. 文件上传流程

```
POST /api/v1/convert
   ↓
接收文件 → 验证 → 生成任务ID
   ↓
添加到队列 → 返回 202 Accepted
```

### 2. 异步处理流程

```
队列消费者
   ↓
取出任务 → 设置状态为 processing
   ↓
解压文件 → 解析 XML
   ↓
遍历幻灯片:
   ├─ 解析幻灯片 XML
   ├─ 遍历元素
   ├─ 转换元素（使用注册的转换器）
   └─ 处理特殊情况（图表、表格等）
   ↓
序列化结果 → 保存文件
   ↓
设置状态为 completed → 返回结果
```

### 3. 错误处理流程

```
转换过程
   ↓
捕获异常 → 记录日志
   ↓
[错误分类]
   ├─ 文件损坏 → 标记为 failed，记录警告
   ├─ 元素不支持 → 跳过元素，记录警告
   ├─ 内存不足 → 尝试优化，重新处理
   └─ 系统错误 → 标记为 failed，返回错误
   ↓
更新任务状态 → 返回错误信息
```

---

## 队列系统

### 队列架构

```
Memory Queue (默认)
   ↓
[Task Queue]
   ├─ queued:     等待处理的任务
   ├─ processing: 正在处理的任务
   ├─ completed:  已完成的任务
   └─ failed:     失败的任务
```

### 任务生命周期

```
Created → Queued → Processing → Completed
                     ↓                    ↓
                  Failed               Deleted
```

### 并发控制

```typescript
interface QueueOptions {
  concurrency: number;  // 最大并发数
  maxSize: number;       // 队列最大长度
  timeout: number;       // 任务超时（毫秒）
}
```

---

## 错误处理

### 错误分类

1. **用户错误**
   - 无效文件类型
   - 文件过大
   - 文件损坏
   - 处理: 返回 4xx 错误码

2. **系统错误**
   - 内存不足
   - 磁盘空间不足
   - 网络错误
   - 处理: 返回 500 错误码，记录日志

3. **转换错误**
   - 不支持的元素
   - 解析失败
   - 处理: 跳过元素，记录警告

### 错误恢复策略

```
[错误发生]
   ↓
[分类]
   ├─ 可恢复错误 → 重试 / 跳过
   ├─ 临时错误 → 等待重试
   └─ 永久错误 → 标记失败
   ↓
[更新任务状态]
   ├─ 添加错误信息
   ├─ 生成警告
   └─ 继续处理
```

---

## 性能优化

### 1. 流式处理

**目的**: 避免大文件内存峰值

```
大文件 (>10MB)
   ↓
[分块读取]
   ├─ Read chunk (64KB)
   ├─ Process chunk
   └─ Discard chunk
   ↓
[输出流]
```

### 2. 智能缓存

**策略**: LRU (Least Recently Used)

```
[Cache Hit?]
   ├─ Yes → 返回缓存结果
   └─ No → 执行转换
                 ↓
             [保存到缓存]
```

**缓存键**: `MD5(file hash + options)`

### 3. 并发优化

**队列消费者池**:

```
┌─────────┐  ┌─────────┐  ┌─────────┐
│Consumer1│  │Consumer2│  │Consumer3│
└─────┬───┘  └─────┬───┘  └─────┬───┘
      │            │             │
      └────────────┴─────────────┘
                    ↓
              [Task Queue]
```

---

## 安全性

### 1. 输入验证

```
[接收文件]
   ↓
[多级验证]
   ├─ 文件名清理（路径遍历防护）
   ├─ 文件扩展名检查
   ├─ Magic Number 验证
   ├─ 文件大小限制
   └─ MIME 类型检查
   ↓
[安全文件]
```

### 2. 敏感信息保护

**日志脱敏**:
```typescript
// 自动脱敏的字段
- password
- token
- apiKey
- secret
- authorization
- cookie
```

**日志级别**:
- 生产环境: `info` 或 `warn`
- 开发环境: `debug`

### 3. 速率限制

**策略**:
- 100 请求/分钟/IP
- 白名单: `127.0.0.1`, `::1`
- 超限返回: `429 Too Many Requests`

### 4. CORS 配置

**开发环境**:
```
origin: *           # 允许所有源
credentials: true   # 允许凭证
methods: *         # 允许所有方法
```

**生产环境**:
```
origin: https://example.com  # 指定域名
credentials: true
methods: [GET, POST]         # 限制方法
```

---

## 扩展性

### 添加新元素转换器

1. 创建转换器类:

```typescript
import { BaseConverter } from './base-converter.js';

export class CustomConverter extends BaseConverter {
  convert(element: any, context: ConversionContext): any {
    // 转换逻辑
  }
}
```

2. 注册转换器:

```typescript
import { ConverterRegistry } from './registry.js';

const converter = new CustomConverter();
registry.register(converter);
```

3. 自动可用

---

## 监控和日志

### 结构化日志

**日志级别**:
- `trace` - 详细的调试信息
- `debug` - 调试信息
- `info` - 一般信息
- `warn` - 警告信息
- `error` - 错误信息
- `fatal` - 致命错误

**日志格式**:
- JSON: 生产环境
- Pretty: 开发环境

### Prometheus 指标

**核心指标**:
```
- HTTP 请求数和延迟
- 转换成功率和持续时间
- 队列深度和处理时间
- 缓存命中率
- 系统资源使用
```

**告警规则**:
- 高错误率 (>5%)
- 高延迟 (P95 > 5s)
- 队列积压 (>100 任务)
- 内存使用率 (>80%)

---

## 技术债务

### 已知限制

1. **转换器覆盖**: 部分高级转换器待实现
2. **动画支持**: 动画提取和转换基础实现
3. **图表支持**: 图表转换功能有限
4. **表格支持**: 表格转换功能基础实现

### 改进计划

**短期** (1-2 个月):
- 完善转换器单元测试
- 实现更多图表类型支持
- 优化大文件性能

**中期** (3-6 个月):
- 实现动画完整支持
- 添加更多图表类型
- 实现批量转换

**长期** (6-12 个月):
- 版本转换支持
- PPTX 模板支持
- 自定义主题支持

---

**文档维护**: PPTist Backend Team
**最后更新**: 2025-01-29
